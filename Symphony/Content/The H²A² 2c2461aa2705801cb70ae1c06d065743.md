# The HÂ²AÂ²

> ğŸ›ï¸ Hexagonal + Actor Hybrid Architecture
> 
> 
> *Symphony's intelligent backend design pattern that harmonizes stability with creativity*
> 
> [Code Details](Code%20Details%202c2461aa27058034a11ce51e952683b1.md)
> 

---

## ğŸ¯ What is HÂ²AÂ²?

The HÂ²AÂ² (Hexagonal + Actor Hybrid Architecture) is Symphony's architectural foundation that elegently solves a critical challenge: **How do you build a system that's both rock-solid and infinitely extensible?**

### The Core Innovation

Symphony combines two proven architectural patterns into a seamless hybrid:

**ğŸ”· Hexagonal Architecture** (Ports & Adapters)

- Isolates business logic from infrastructure concerns
- Enables testing without external dependencies
- Provides clean boundaries between "what" and "how"

**ğŸ­ Actor Model**

- Provides fault-isolated concurrency for extensions
- Each extension runs independently, crashes don't propagate
- Natural lifecycle management and hot-reload support

---

## ğŸ¤” The Problem We're Solving

Symphony faces a unique architectural challenge that traditional IDE designs can't handle:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    THE INTEGRATION PUZZLE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   Xi-Editor              Symphony Core           Extensions    â”‚
â”‚   (External)             (Our Code)              (Community)   â”‚
â”‚       â”‚                       â”‚                       â”‚         â”‚
â”‚       â–¼                       â–¼                       â–¼         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚   â”‚ Rope   â”‚            â”‚Conduct-â”‚             â”‚Custom  â”‚      â”‚
â”‚   â”‚ CRDT   â”‚            â”‚  or    â”‚             â”‚ Code   â”‚      â”‚
â”‚   â”‚ LSP    â”‚            â”‚ Logic  â”‚             â”‚ Bugs   â”‚      â”‚
â”‚   â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜      â”‚
â”‚       â”‚                     â”‚                      â”‚            â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                             â”‚                                   â”‚
â”‚                             â–¼                                   â”‚
â”‚                     HOW DO WE INTEGRATE?                        â”‚
â”‚                                                                 â”‚
â”‚   â€¢ Xi-Editor has its own API that might change                â”‚
â”‚   â€¢ Symphony needs to test without Xi-Editor                   â”‚
â”‚   â€¢ Extensions must not crash the core system                  â”‚
â”‚   â€¢ Performance must be < 100ns for hot paths                  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

**The Requirements:**

- **ğŸ”’ Isolation**: Third-party extensions can't crash the core
- **âš¡ Performance**: Infrastructure operations need nanosecond-level speed
- **ğŸ§ª Testability**: Must test business logic without external dependencies
- **ğŸ”„ Flexibility**: Swap components without rewriting the system
- **ğŸ›¡ï¸ Safety**: One component's failure shouldn't cascade

---

## ğŸ—ï¸ The HÂ²AÂ² Solution

### Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SYMPHONY HEXAGONAL + ACTOR HYBRID                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘                    DOMAIN CORE                            â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â•‘  â”‚
â”‚  â•‘  â”‚         Orchestration Engine (Pure Rust)            â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  â€¢ Workflow execution logic                         â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  â€¢ Extension policy enforcement                     â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  â€¢ Conductor integration logic                      â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  â€¢ Melody composition                               â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  â€¢ NO external dependencies                         â”‚  â•‘  â”‚
â”‚  â•‘  â”‚  â€¢ Fully testable in isolation                      â”‚  â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â•‘  â”‚
â”‚  â•‘                           â†“                               â•‘  â”‚
â”‚  â•‘                   Uses only Ports (Traits)                â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚                            â†“                                    â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘                     PORT LAYER                            â•‘  â”‚
â”‚  â•‘                                                           â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â•‘  â”‚
â”‚  â•‘  â”‚TextEditing-  â”‚ â”‚   PitPort    â”‚ â”‚ Extension-   â”‚     â•‘  â”‚
â”‚  â•‘  â”‚    Port      â”‚ â”‚              â”‚ â”‚    Port      â”‚     â•‘  â”‚
â”‚  â•‘  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚     â•‘  â”‚
â”‚  â•‘  â”‚â€¢ insert()    â”‚ â”‚â€¢ allocate()  â”‚ â”‚â€¢ load()      â”‚     â•‘  â”‚
â”‚  â•‘  â”‚â€¢ delete()    â”‚ â”‚â€¢ execute()   â”‚ â”‚â€¢ unload()    â”‚     â•‘  â”‚
â”‚  â•‘  â”‚â€¢ undo()      â”‚ â”‚â€¢ store()     â”‚ â”‚â€¢ invoke()    â”‚     â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘  â”‚
â”‚  â•‘         â”‚                â”‚                â”‚             â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚           â”‚                â”‚                â”‚                 â”‚
â”‚  â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—  â”‚
â”‚  â•‘                   ADAPTER LAYER                           â•‘  â”‚
â”‚  â•‘         â”‚                â”‚                â”‚               â•‘  â”‚
â”‚  â•‘  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”     â•‘  â”‚
â”‚  â•‘  â”‚  Xi-Core     â”‚ â”‚    Pit       â”‚ â”‚   Actor      â”‚     â•‘  â”‚
â”‚  â•‘  â”‚  Adapter     â”‚ â”‚  Adapter     â”‚ â”‚  Adapter     â”‚     â•‘  â”‚
â”‚  â•‘  â”‚              â”‚ â”‚              â”‚ â”‚              â”‚     â•‘  â”‚
â”‚  â•‘  â”‚ JSON-RPC     â”‚ â”‚ Direct Rust  â”‚ â”‚ Actor Msgs   â”‚     â•‘  â”‚
â”‚  â•‘  â”‚ to Xi-Editor â”‚ â”‚ Calls 50ns   â”‚ â”‚ Isolated     â”‚     â•‘  â”‚
â”‚  â•‘  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â•‘  â”‚
â”‚  â•‘         â”‚                â”‚                â”‚             â•‘  â”‚
â”‚  â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚           â”‚                â”‚                â”‚                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                  â”‚ â”‚              â”‚ â”‚               â”‚    â”‚
â”‚  â”‚   XI-EDITOR      â”‚ â”‚  THE PIT     â”‚ â”‚ GRAND STAGE   â”‚    â”‚
â”‚  â”‚                  â”‚ â”‚              â”‚ â”‚               â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚  xi-rope    â”‚ â”‚ â”‚ â”‚Pool Mgr  â”‚ â”‚ â”‚ â”‚Instrumentâ”‚ â”‚    â”‚
â”‚  â”‚  â”‚  xi-core    â”‚ â”‚ â”‚ â”‚DAG Track â”‚ â”‚ â”‚ â”‚Operators â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  xi-rpc     â”‚ â”‚ â”‚ â”‚Artifact  â”‚ â”‚ â”‚ â”‚Motifs    â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  xi-lsp     â”‚ â”‚ â”‚ â”‚Arbitrate â”‚ â”‚ â”‚ â”‚          â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚Stale Mgr â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚                  â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚              â”‚    â”‚
â”‚  â”‚  âœ— xi-plugin    â”‚ â”‚              â”‚ â”‚  Actor-Based â”‚    â”‚
â”‚  â”‚  (NOT USED)      â”‚ â”‚ Direct Calls â”‚ â”‚  Isolation   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

---

## ğŸ¼ The Three Layers Explained

### ğŸ¯ Layer 1: The Domain Core

**What it is:** Pure business logic that defines *what* Symphony does, not *how* it does it.

**Key Characteristics:**

- âœ… **Zero external dependencies** (only standard Rust)
- âœ… **Fully testable** in isolation with mocks
- âœ… **Framework-agnostic** design
- âœ… **Expresses business concepts** in clean code

**What lives here:**

- Orchestration Engine - coordinates all Symphony operations
- Workflow execution logic - how melodies are composed and run
- Extension policy enforcement - security and permission rules
- Conductor integration - interfaces with the Python RL brain

**Design principle:** The domain core has no idea whether it's talking to Xi-editor, a test mock, or any other implementation. It only knows the *interface* (ports).

---

### ğŸ”Œ Layer 2: The Port Layer

**What it is:** Trait definitions that specify *what* the domain needs from the outside world.

**The Four Main Ports:**

**ğŸ“ TextEditingPort**

- Purpose: Text editing operations
- Methods: insert, delete, replace, undo, redo
- Implemented by: Xi-Core Adapter

**ğŸŠ PitPort**

- Purpose: High-performance infrastructure operations
- Methods: allocate_model, execute_node, store_artifact
- Implemented by: Pit Adapter (direct Rust calls for 50-100ns performance)

**ğŸ­ ExtensionPort**

- Purpose: Extension lifecycle and invocation
- Methods: load, unload, invoke, status
- Implemented by: Actor Adapter (message-based isolation)

**ğŸ© ConductorPort**

- Purpose: Python RL model integration
- Methods: decide, report_outcome, get_strategy
- Implemented by: PyO3 Bridge Adapter

**Design principle:** Ports define *capabilities*, not implementations. The domain says "I need the ability to insert text" without caring how that happens.

---

### ğŸ”§ Layer 3: The Adapter Layer

**What it is:** Concrete implementations that translate domain concepts to real infrastructure.

**Why Two Different Approaches?**

| Component | Execution Model | Rationale |
| --- | --- | --- |
| **The Pit** | Direct Rust calls (50-100ns) | Infrastructure needs maximum performance, trusted code |
| **Extensions** | Actor-based isolation | Community code needs fault isolation, independent lifecycle |
| **Xi-Editor** | JSON-RPC over IPC | External process, established protocol |
| **Conductor** | PyO3 FFI Bridge | Python interop, ~0.01ms overhead |

**Key Insight:** Not all integrations are created equal. We optimize each adapter for its specific needs rather than forcing a one-size-fits-all approach.

---

## ğŸ­ The Actor Model for Extensions

### Why Actors for the Grand Stage?

Traditional extension systems have a fatal flaw: **one bad extension can crash everything**. The Actor Model solves this elegantly.

**ğŸ›¡ï¸ Fault Isolation in Action:**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  EXTENSION LIFECYCLE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚INSTALLEDâ”‚â”€â”€â”€â”€â–ºâ”‚ LOADING â”‚â”€â”€â”€â”€â–ºâ”‚  READY  â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜             â”‚
â”‚                        â”‚               â”‚                   â”‚
â”‚                        â”‚ Error         â”‚ Invoke            â”‚
â”‚                        â–¼               â–¼                   â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                   â”‚  ERROR  â”‚    â”‚EXECUTING â”‚             â”‚
â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                        â”‚              â”‚                    â”‚
â”‚                        â”‚ Retry        â”‚ Complete           â”‚
â”‚                        â–¼              â–¼                    â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚                   â”‚RELOADINGâ”‚    â”‚  IDLE   â”‚â—„â”€â”€â”€â”€â”        â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜     â”‚        â”‚
â”‚                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                       (back to ready)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

**Benefits:**

- ğŸ”¥ **Crash Isolation**: Extension panic doesn't affect the core
- ğŸ”„ **Hot Reload**: Load/unload extensions without system restart
- âš–ï¸ **Resource Control**: Limit memory and CPU per extension
- ğŸ“Š **Lifecycle Management**: Monitor health, restart on failure
- ğŸ¯ **Clear Communication**: Message passing ensures clean boundaries

---

## âš¡ Performance Strategy

### Performance Targets by Component

| Component | Operation | Target | Strategy |
| --- | --- | --- | --- |
| **The Pit** | Model allocation (cache hit) | 50-100ns | Lock-free data structures, direct calls |
| **The Pit** | Artifact store | 1-5ms | Content-addressable storage, indexing |
| **The Pit** | Artifact retrieve | 0.5-2ms | In-memory cache, fast lookup |
| **Xi-Adapter** | Insert/delete | <5ms | Batched operations, JSON-RPC pooling |
| **Actor Layer** | Message send | 100ns-1Î¼s | Bounded channels, efficient serialization |
| **Extensions** | Invoke (Wasm) | <50ms | Pre-warmed sandbox, streaming |

### Why Different Performance Profiles?

**The Pit (50-100ns):**

- Called thousands of times per workflow
- Trusted, battle-tested code
- Direct memory access justified

**Extensions (50ms):**

- Called once or twice per workflow
- Untrusted community code
- Safety overhead is acceptable

**Key Insight:** **Don't optimize prematurely**. The architecture allows us to optimize each layer independently based on actual profiling data.

---

## ğŸ§ª Testing Philosophy

### The Testing Pyramid

```
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚  E2E Tests     â”‚  < 10% - Full system, real Xi-editor
                â”‚  (Slow, Few)   â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚Integration Testsâ”‚  ~20% - Real adapters, mocked external
                â”‚   (Medium)      â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚        Unit Tests               â”‚  > 70% - Mocked ports, pure logic
        â”‚    (Fast, Many, Isolated)       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

### The Hexagonal Advantage

Because the domain core depends only on port traits, **we can test business logic without any infrastructure**:

**Example: Testing Workflow Execution**

```
Test Setup:
  âœ“ Create mock implementations of ports
  âœ“ Set expectations (e.g., "expect insert() to be called once")
  âœ“ Pass mocks to OrchestrationEngine
  âœ“ Execute workflow
  âœ“ Verify all expectations met

Result: Business logic tested in milliseconds, not seconds

```

**Without Hexagonal:**

- Need to spin up Xi-editor process
- Need to initialize database
- Need to start actor system
- Tests are slow, flaky, and hard to debug

**With Hexagonal:**

- Mock all ports in-memory
- Tests run in microseconds
- Perfect isolation
- Clear failure messages

---

## ğŸ”„ Data Flow Examples

### Example 1: User Types a Character

```
User Input                                           Display
    â”‚                                                   â–²
    â–¼                                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
â”‚Frontend â”‚â”€â”€â”€â”€â–ºâ”‚ Domain Core      â”‚â”€â”€â”€â”€â–ºâ”‚TextEditing-   â”‚
â”‚(Tauri)  â”‚     â”‚ OrchestrationMgr â”‚     â”‚    Port       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                                          â”‚ XiCore      â”‚
                                          â”‚ Adapter     â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                                          â”‚ Xi-Editor   â”‚â”€â”€â”€â”€â”˜
                                          â”‚ (rope edit) â”‚
                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

**Flow:**

1. User types in frontend
2. Frontend calls domain core
3. Domain core calls TextEditingPort
4. XiCore Adapter translates to Xi-editor API
5. Xi-editor performs rope operation
6. Result flows back up the chain
7. Frontend updates display

**Key Insight:** The domain core never knows it's talking to Xi-editor. It could be a test mock, a different editor, or even a remote service.

---

### Example 2: AI Extension Processes Code

```
Conductor Decision                                    Result
    â”‚                                                    â–²
    â–¼                                                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
â”‚Conductor    â”‚â”€â”€â”€â”€â–ºâ”‚ Domain Core      â”‚â”€â”€â”€â”€â–ºâ”‚Extension-      â”‚
â”‚Port         â”‚     â”‚ execute_workflow â”‚     â”‚    Port        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                                               â”‚Actor        â”‚
                                               â”‚Adapter      â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                                               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                                               â”‚Extension    â”‚â”€â”€â”€â”€â”€â”€â”€â”˜
                                               â”‚Actor        â”‚
                                               â”‚(Isolated)   â”‚
                                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

**Flow:**

1. Conductor makes orchestration decision
2. Domain core executes workflow step
3. Domain core calls ExtensionPort
4. Actor Adapter sends message to extension actor
5. Extension executes in isolation
6. Result sent back via message
7. Domain core continues workflow

**Key Insight:** The extension runs in complete isolation. If it crashes, the Actor supervisor detects this and can restart it without affecting the core system.

---

## ğŸ¨ Xi-Editor Integration Strategy

### What We Use from Xi-Editor

| Crate | Purpose | How We Use It |
| --- | --- | --- |
| **xi-rope** | Efficient text storage | Core text data structure for buffers |
| **xi-core-lib** | Editing operations | Edit, undo, redo operations |
| **xi-rpc** | JSON-RPC protocol | Communication between processes |
| **xi-unicode** | Unicode handling | Character boundaries, grapheme clusters |
| **xi-lsp-lib** | LSP client | Language server protocol integration |

### What We DON'T Use

| Crate | Purpose | Why Not |
| --- | --- | --- |
| **xi-plugin-lib** | Xi's plugin system | âŒ **Replaced by Symphony's extension system** |
| **xi-syntect-plugin** | Syntax highlighting | Will be a Symphony Motif extension |

### The Integration Boundary

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  SYMPHONY + XI-EDITOR                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚   Symphony Domain                                           â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  OrchestrationEngine<impl TextEditingPort, ...>    â”‚   â”‚
â”‚   â”‚                                                     â”‚   â”‚
â”‚   â”‚  â€¢ Never imports xi-* crates directly              â”‚   â”‚
â”‚   â”‚  â€¢ Uses TextEditingPort trait only                 â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                          â”‚                                  â”‚
â”‚                          â”‚ Uses trait                       â”‚
â”‚                          â–¼                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  XiCoreAdapter (implements TextEditingPort)         â”‚   â”‚
â”‚   â”‚                                                     â”‚   â”‚
â”‚   â”‚  â€¢ Translates domain types â†” Xi-editor types       â”‚   â”‚
â”‚   â”‚  â€¢ Manages Xi-editor process lifecycle             â”‚   â”‚
â”‚   â”‚  â€¢ Handles JSON-RPC communication                  â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â”‚ JSON-RPC                          â”‚
â”‚                         â–¼                                   â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚  Xi-Editor Core Process                             â”‚   â”‚
â”‚   â”‚                                                     â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚   â”‚
â”‚   â”‚  â”‚ xi-rope   â”‚ â”‚ xi-core   â”‚ â”‚ xi-rpc    â”‚        â”‚   â”‚
â”‚   â”‚  â”‚ Rope data â”‚ â”‚ Edit ops  â”‚ â”‚ Protocol  â”‚        â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚   â”‚
â”‚   â”‚                                                     â”‚   â”‚
â”‚   â”‚  âœ— xi-plugin-lib (NOT LOADED)                      â”‚   â”‚
â”‚   â”‚  âœ— Xi's plugin system bypassed                     â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

**Key Decision:** We use Xi-editor's excellent rope and editing engine, but replace its plugin system with Symphony's more powerful extension architecture.

---

## ğŸŠ The Pit: Performance-Critical Infrastructure

The Pit consists of five high-performance Rust extensions that form Symphony's infrastructure layer.

### The Five Components

**ğŸŠ Pool Manager** - *The Resource Maestro*

- Manages AI model lifecycle with predictive pre-warming
- Target: 50-100ns allocation for cache hits
- Uses lock-free data structures for maximum speed

**ğŸ“Š DAG Tracker** - *The Workflow Cartographer*

- Tracks workflow dependencies and execution state
- Enables checkpointing and recovery
- Detects critical paths for optimization

**ğŸ“¦ Artifact Store** - *The Institutional Memory*

- Content-addressable storage with quality scoring
- Full-text search with Tantivy indexing
- Version tracking and deduplication

**âš–ï¸ Arbitration Engine** - *The Wise Judge*

- Resolves resource conflicts intelligently
- Enforces fairness and priority policies
- Prevents deadlocks

**ğŸ§¹ Stale Manager** - *The Training Data Curator*

- Manages artifact lifecycle (local â†’ cloud â†’ delete)
- Preserves valuable training data
- Storage-aware cleanup decisions

### Why Direct Calls for The Pit?

The Pit uses **direct Rust function calls** instead of actor messages because:

âœ… **Performance Critical**: Operations called thousands of times per workflow
âœ… **Trusted Code**: Battle-tested, crash-free components
âœ… **Predictable Latency**: No message queue overhead
âœ… **Shared State**: Direct memory access when needed

**Trade-off:** Less isolation, but acceptable for trusted infrastructure code.

---

## ğŸª The Grand Stage: Extension System

The Grand Stage hosts user-facing extensions using the Actor model for maximum safety.

### The Three Extension Types

**ğŸ» Instruments** - AI/ML Models

- Purpose: Bring intelligence to workflows
- Examples: Code completion, refactoring, analysis
- Runtime: Wasm sandbox or separate process

**âš™ï¸ Operators** - Workflow Utilities

- Purpose: Data transformation and orchestration
- Examples: File converters, Git operations, API calls
- Runtime: Lightweight, deterministic

**ğŸ§© Addons (Motifs)** - UI Enhancements

- Purpose: Visual and experiential improvements
- Examples: Custom themes, specialized editors, panels
- Runtime: WebView or native UI components

### Sandboxing Strategies

| Trust Level | Sandbox Type | Use Case |
| --- | --- | --- |
| **Untrusted** | Wasm | Marketplace extensions from unknown developers |
| **Semi-trusted** | Process | Complex extensions from known developers |
| **Trusted** | Native (with capabilities) | Core Symphony extensions only |

**Security Model:**

- ğŸ”’ All extensions explicitly declare required permissions
- ğŸš« Extensions cannot access resources they don't request
- ğŸ“Š Complete audit trail of all extension actions
- â±ï¸ Timeouts and resource limits enforced

---

## ğŸ¯ Design Principles & Best Practices

### Port Design Principles

| âœ… Do | âŒ Don't |
| --- | --- |
| Express domain concepts | Expose infrastructure details |
| Keep ports cohesive | Create too many tiny ports |
| Use domain error types | Leak adapter errors through ports |
| Make ports `Send + Sync` | Use non-thread-safe types |
| Document expected behavior | Assume behavior from implementation |

### Adapter Design Principles

| âœ… Do | âŒ Don't |
| --- | --- |
| Translate types at boundary | Pass infrastructure types to domain |
| Handle all external errors | Let panics propagate |
| Keep adapters stateless | Store business logic in adapters |
| Use constructor injection | Hardcode dependencies |
| Test with mock externals | Test only with real externals |

### The Golden Rule

**"Business logic in the core, everything else is pluggable infrastructure."**

This means:

- Domain core makes business decisions
- Adapters translate those decisions to actions
- No business logic leaks into adapters
- No infrastructure details leak into domain

---

### The Bigger Picture

HÂ²AÂ² isn't just an architectureâ€”it's a **philosophy**:

> "Build systems that are easy to understand, easy to test, and easy to change."
> 

By combining Hexagonal Architecture with the Actor Model, Symphony achieves something rare: a system that's both **stable** and **extensible**, **fast** and **safe**, **simple** and **powerful**.

---

*HÂ²AÂ²: Where architectural elegance meets practical engineering* ğŸ›ï¸